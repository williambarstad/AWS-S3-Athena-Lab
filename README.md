# Athena Demo Project
> Work in progress.



This project provisions AWS resources to work with Amazon Athena using Terraform. It includes an Amazon S3 bucket, an AWS Glue catalog database, and an AWS Glue catalog table to facilitate querying CSV data stored in S3 using Athena.

## Project Resources

### 1. AWS Glue Catalog Database (`athena_database`)
The `aws_glue_catalog_database` resource defines a Glue catalog database named **athena_demo_db**. This is the logical container for the tables used by Athena.

### 2. AWS Glue Catalog Table (`athena_table`)
The `aws_glue_catalog_table` resource defines a table named **drivers** in the **athena_demo_db** database. This table points to CSV data stored in an S3 bucket. It is configured as an external table, meaning that the data is stored outside of the Glue environment, specifically in the S3 bucket created by this project. The table uses the **OpenCSVSerde** serialization library to parse CSV-formatted data.

- **Table Parameters**:
  - `classification`: Defines the data format as CSV.
- **Storage Descriptor**:
  - **Location**: Specifies the location of the CSV data in the S3 bucket.
  - **Input Format**: Specifies how the data will be read.
  - **Output Format**: Specifies how the data will be written.
  - **SerDe Info**: Configures the serialization library used for reading and writing data (in this case, OpenCSVSerde).

### 3. Randomized S3 Bucket Name
The S3 bucket resource (`aws_s3_bucket`) is defined with a unique name by using a random ID generated with the `random_id` resource. This ensures the bucket name is globally unique, as S3 bucket names must not be duplicated across all AWS accounts. The bucket name is formed using the pattern `athena-demo-bucket-<random_suffix>`, where the random suffix is an 8-byte string.

#### Example Randomizer Code:
```hcl
resource "random_id" "bucket_id" {
  byte_length = 8
}

resource "aws_s3_bucket" "athena_demo_bucket" {
  bucket = "athena-demo-bucket-${random_id.bucket_id.hex}"
}
```

## Example Athena Query
Once the table is created and the data is uploaded to the S3 bucket, you can use Amazon Athena to query the **drivers** table. Below is an example SQL query to get the first 10 records from the table:

```sql
SELECT *
FROM "athena_demo_db"."drivers"
LIMIT 10;
```

This query retrieves data from the **drivers** table and limits the result to 10 rows. Make sure your CSV data is uploaded to the S3 bucket defined in the Terraform code before running the query.

### Running the Query from the Command Line
You can run the Athena query from your PowerShell command line using the AWS CLI. Below is an example command to execute the query:

```powershell
aws athena start-query-execution -query-string "SELECT * FROM \"athena_demo_db\".\"drivers\" LIMIT 10;" -query-execution-context Database=athena_demo_db -result-configuration OutputLocation=s3://<your-output-bucket>/query-results/
```

Replace `<your-output-bucket>` with the name of an S3 bucket where you want to store the query results. Make sure that the bucket exists and that you have permissions to write to it.

## How to Use This Project
1. Clone the repository and navigate to the project directory.
2. Ensure you have configured your AWS credentials correctly.
3. Run `terraform init` to initialize the Terraform configuration.
4. Run `terraform apply` to create the AWS resources.
5. Upload your CSV data to the created S3 bucket.
6. Use the provided Athena query to explore the data.

## Cost estimation
> Generated by Infracost
```
Project: main

 Name                                             Monthly Qty  Unit                    Monthly Cost

 aws_glue_catalog_database.athena_database
 ├─ Storage                                 Monthly cost depends on usage: $1.00 per 100k objects
 └─ Requests                                Monthly cost depends on usage: $1.00 per 1M requests

 aws_s3_bucket.athena_demo_bucket
 └─ Standard
    ├─ Storage                              Monthly cost depends on usage: $0.023 per GB
    ├─ PUT, COPY, POST, LIST requests       Monthly cost depends on usage: $0.005 per 1k requests
    ├─ GET, SELECT, and all other requests  Monthly cost depends on usage: $0.0004 per 1k requests
    ├─ Select data scanned                  Monthly cost depends on usage: $0.002 per GB
    └─ Select data returned                 Monthly cost depends on usage: $0.0007 per GB

 OVERALL TOTAL                                                                               $0.00

*Usage costs can be estimated by updating Infracost Cloud settings, see docs for other options.

──────────────────────────────────
18 cloud resources were detected:
∙ 2 were estimated
∙ 16 were free

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━┓
┃ Project                                            ┃ Baseline cost ┃ Usage cost* ┃ Total cost ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╋━━━━━━━━━━━━━━━╋━━━━━━━━━━━━━╋━━━━━━━━━━━━┫
┃ main                                               ┃         $0.00 ┃           - ┃      $0.00 ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━┻━━━━━━━━━━━━┛
```